# Code シリーズ

## 利用シーン

1. ソースを CodeCommit のリポジトリへプッシュ
2. CodeBuild でビルド
3. テスト(CodeDeploy)
4. OK
5. CodeDeploy でデプロイ
   ※CodePipeline でプロセスを統合

## CodeCommit

Git の標準機能を持っていて、プルリクエストの対応も可能

### リポジトリ

ソースコードの保存場所
既存の Git リポジトリからの意向も可能

ファイル編集には CodeCommit コンソール、AWS CLI、CodeCommitAPI を使用する

CodeCommit のユーザー認証設定

- IAM ユーザーとの関連付けで行う
  - 発行されたユーザー名とパスワードで Git の認証を行う
  - IAM ポリシーで特定のブランチへのプッシュやマージの制限も可能
- 通信暗号化
  - HTTPS,SSH を使用
  - リポジトリのソースコードは KMS キーによって暗号化される

### 他のサービスと連携

- CloudTrail と連携して AWS で発行される CodeCommitAPI の利用状況を S3 に保存する
- SNS に通知
- トリガー(リポジトリへのプッシュなど)を設定し Lambda 関数を実行する

## CodeBuild

コンパイル、静的解析、単体テストを実行してデプロイ可能なファイル群を出力する。

デプロイ可能なファイル群　＝　アーティファクト

負荷に応じて自動的にスケーリングされるため、高負荷な状態になってもリソースの増強の必要がない

料金はビルド時間に対して課金される

### ビルドプロジェクト

ビルドの目的ごとに１つ作成される
ビルドプロジェクトごとに１つのリポジトリやアーティファクトのアップロード場所を指定できる

### ビルドの開始

コンソールで実行、または AWS 　 CLI で実行
CodePipeline を組み込むことで、CodeCommit のソースの変更を検知してビルドすることも可能

### ビルド環境構築

ビルド実行時の環境を DockerImage を指定して定義する

独自にカスタマイズしたイメージを ECR に登録して使用することもできる

### 資源ダウンロード

リポジトリは CodeCommit の他、BitBucket,Github,S3 も指定できる

### ビルド実行

buildspec.yml にしたがって実行される

### アーティファクトのアップロード

指定した S3 バケットに保存される

### Log

Cloudwatch Logs にビルドログとビルド結果が送信される

## CodeDeploy

デプロイ自動化
EC2 インスタンス、ECS、Lambda へのデプロイ
Blue/Green デプロイの実施も可能

![スクリーンショット 2020-06-01 23 43 47](https://user-images.githubusercontent.com/36391432/83421941-c7431000-a463-11ea-9fe9-a9847e9b1f9c.png)

### デプロイタイプ

- インプレースデプロイ(元のインスタンスにデプロイ)
- Blue/Green デプロイ(新しい AutoScalingGroup を作成した後にトラフィックを切り替える)

## CodePipeLine

リリースプロセスの自動化
手動の承認プロセスの追加も可能

![スクリーンショット 2020-06-01 23 46 20](https://user-images.githubusercontent.com/36391432/83421997-dd50d080-a463-11ea-852f-aafcecf6f7ec.png)

### 連携できるサービス

サードパーティー製のツール(Github, Jenkins など)との連携も可能

### 承認アクション

SNS トピックを指定し、承認アクションが発生したタイミングでメールで通知するなど
