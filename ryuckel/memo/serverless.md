# Lambda

以下をトリガーにして関数を実行できる

- S3 へのファイル保存
- DynamoDB のデータ変更
- SQS キューにメッセージが追加される
- APIGateway に HTTP リクエストが送信される
- AWS SDK を用いたモバイルアプリから関数が呼び出される

## イベントソース

- Push

同期呼び出し：処理を完了して結果をレスポンスとして返す
非同期呼び出し：実行命令だけ送って処理の完了は待たない

- Pull

DynamoDB、Kinesis Stream をトリガーとするストリームベース
SQS のキューをトリガーとするキューベース


![スクリーンショット 2020-06-02 13 27 16](https://user-images.githubusercontent.com/36391432/83480583-c8f9eb80-a4d6-11ea-9f70-11bb4422f32e.png)

## 関数の作成

1. マネジメントコンソールから直接入力する
2. マネジメントコンソールの Lambda の画面上で ZIP ファイルをアップロードする
3. S3 に ZIP ファイルをアップロードして参照させる

## 対応言語

Node.js,Python,Go,Ruby,.NET
それ以外の言語もカスタムランタイムで利用することができる

## ライブラリの利用

ZIP 化して Lambda にアップロードする必要がある。
コードは必ずルートディレクトリに含める

## Lambda レイヤー

複数の Lambda 関数でコードを共有する(共通機能を作って使いまわせる)
1 つの Lambda 関数で 5 妻で指定することができる

## Lambda 関数の基本設定

メモリは 128~3008MB まで指定され、比例する CPU が割り当てられる
タイムアウトは最長で 15 分

## Lambda 関数の環境変数

処理に応じて関数内の変数の値を変えたい場合は環境変数を定義して参照する
DB の接続情報など

## Lambda 関数の同時実行数とスロットリング

ある時点で同時に実行されている Lambda 関数の数
同一アカウント同一リージョンにつき 1000 件まで

上限に達するとスロットリングされて実行されない
イベントのソースによって処理方法が変わる

![スクリーンショット 2020-06-02 13 27 02](https://user-images.githubusercontent.com/36391432/83480588-cbf4dc00-a4d6-11ea-83a6-32f514df2fd9.png)

## Lambda 関数のリトライ

失敗してリトライするときの処理

![スクリーンショット 2020-06-02 13 26 56](https://user-images.githubusercontent.com/36391432/83480591-cc8d7280-a4d6-11ea-987c-08114a0d8007.png)

## Lambda 関数ポリシーと実行ロール

- Lambda 関数ポリシー
  リソースベースのポリシー
  S3 などに対して割り当てる

- 実行ロール(IAM ロール)
  Lambda 関数に対して割ああてて
  cloudwatch Logs や SQS などのプル型のイベントソースへのアクセス権限を付与する

## VPC アクセス

VPC 内の EC2 や RDS インスタンスに対してアクセスするためには VPC アクセス設定が必要

## Lambda 関数のデバッグ

CloudWatch Logs から紐解く
SAM を使えばローカルで実行して、デバッグも可能

## バージョンとエイリアス

- バージョン
  \$LATEST が関数作成時に付与されて、＄ LATEST 以外のバージョンは
  スナップショットとして発行される
  LATEST 以外のバージョンの ARN は末尾にバージョン番号がつく

- エイリアス
  Lambda 関数の各バージョンに名前をつける
  ARN の末尾につく

→ 更新などでバージョン番号が変わっても Lambda 関数を呼び出すコードを変更する必要がない

## コールドスタートとウォームスタート

## モニタリング

- CloudWatch Logs
  アクセス権限を付与すれば利用可能

- X-Ray
  アプリケーションのパフォーマンス分析、エラー原因特定
  CloudWatch よりも詳細な分析が可能

関数の準備時間、DynamoDB,S3 の呼び出しにかかった時間も計測して可視化してくれる

以下の準備が必要

1. トレースモードをアクティブにする。実行ロールには X-Ray の書き込みに必要な権限が自動的に付与される
2. AWS サービスの呼び出しをモニタリングするには、Lambda 関数のコード内でサブセグメントを発行し、トレースを有効化する

X-Ray を使用する場合は X-Ray デーモンが作動して割り当てられたメモリの一部を消費する

# API GateWay
RESTful,WebSocketAPIの作成、管理

## APIの作成

![スクリーンショット 2020-06-02 13 44 47](https://user-images.githubusercontent.com/36391432/83480806-4160ac80-a4d7-11ea-8f9c-a47e11c33031.png)

## APIの公開

![スクリーンショット 2020-06-02 13 45 08](https://user-images.githubusercontent.com/36391432/83480829-4a517e00-a4d7-11ea-9772-ac2aa55c30c5.png)

## APIドキュメント

ドキュメント作成の機能を使用すると
ソース、メソッド、リクエスト、レスポンスの説明をつけるだけでSwaggerの標準的な形式に沿ったAPIドキュメント定義ファイルをエクスポートできる

Swagger形式のドキュメント定義ファイルをAPIGateWayにインポートしてAPIの作成を開始することも可能

## APIの管理

### アクセス制御
- リソースポリシー
JSON形式で定義してリソースとアクションを制限することができる
 (任意のAWSアカウントのIAMユーザー、IP、VPCエンドポイント)
- IAM認証
APIの各要素へのアクセス権限を設定したIAMポリシーを作成し、IAMユーザーやIAMロールに付与することで、APIへのアクセスの制御が可能になります。
これには、対象の各APIメソッドでIAM認証を有効化する必要があります。
- Lambdaオーソライザー
Lambdaオーソライザーと呼ばれるLambda関数を作成することで、認証プロバイダーでの認証結果をもとに、APIへのアクセス制御をメソッド単位で行えるようになります。
- Cognitoオーソライザー
認証プロバイダーとしてCognitoユーザープールを用いて、APIへのアクセス制御をメソッド単位で行うことも可能です。
Lambda関数の作成の必要はない

### スロットリング
メソッド単位とAPIKey単位で設定できる
スロットリング設定では、レート（1秒あたりのリクエスト数）とバースト（リクエストの同時実行数）を設定します。

- 使用プランとAPIキー
APIキーとは、APIGatewayの使用量を制限するために発行するアクセスキー
APIキーの使用量制限はそれぞれのAPIキーに対して設定するのではなく、使用量プランという設定項目でスロットリング設定を行い、APIキーを使用量プランに紐づけることで設定します。

レートやバーストの他に、クォータ（日、週、月あたりのリクエスト数）も設定します。


### モニタリング

CloudWatchやCloudTrail、そしてXRayと連携して監視を行うことができます。また、標準でマネージメントコンソール上にAPIGatewayダッシュボードが用意されており、
各APIの利用状況をステージごとに可視化して確認することができます。現在、標準で確認できる項目は、以下のとおりです。

- API呼び出し（数）
- キャッシュヒット（APIキャッシュが有効になっている場合のみ）
- キャッシュミス（APIキャッシュが有効になっている場合のみ）
- レイテンシー
- 統合のレイテンシー
- 4XXエラー（数）
- 5XXエラー（数）

### 攻撃からの保護
AWS WAFをステージごとに設定して攻撃から保護する

# DynamoDB
格納容量に上限がないNoSQLデータベース

![スクリーンショット 2020-06-02 14 03 07](https://user-images.githubusercontent.com/36391432/83481844-ce0c6a00-a4d9-11ea-9f39-365c5c296235.png)

## 特徴

### DynamoDB local
DBエンジンのみのソフトウェア。デプロイしなくてもローカル環境で連携テストができる

### 結果整合性の読み込みと強力な整合性の読み込み
DynamoDBは、デフォルトでは結果整合性のデータ読み込みを行います。  
この場合、書き込み直後に読み込むと、書き込み前のデータが返される可能性があります。  
また、この結果整合性の読み込みを、強力な整合性の読み込みに変更することもできます。  

強力な整合性の読み込みは、書き込まれたデータが3つのアベイラビリティーゾーンで完全に保存されたデータのみを読み込みます。
時間がかかるのでタイムアウトする可能性はあるが、書き込みが完了した後の最新データを必ず取得できることが保証されています。
なお、強力な整合性の読み込みを行った場合は、結果整合性の読み込みを行った場合と比較して、後述のRCUを2倍消費します。

### DynamoDBのバックアップ
DynamoDBでは、オンデマンドバックアップと連続的バックアップの2種類の方法でバックアップを取得することができます。  

オンデマンドバックアップは、バックアップ操作を行った時点のテーブルデータをすべて保存します。  
保存している間課金され続けるので、バックアップしたテーブルのサイズによって費用が違ってきますが、いつでもバックアップ取得時点のデータにリストアすることが可能です。

連続的バックアップは、有効にした時点からDynamoDBのテーブルに対するすべての更新処理が記録されます。  
最大で35日間の連続的バックアップが保存され、バックアップが保存されている期間内であれば、ポイントインタイムリカバリが可能です。

### DynamoDBストリーム
DynamoDBに加えられた変更を24時間保存する。  
DynamoDBストリームを有効にすると、DynamoDBストリーム専用のエンドポイントが提供され、そのエンドポイントにアクセスして時系列データを取得できます。  
ほぼリアルタイムで変更内容が反映されるため、新しくデータが追加されたときにクライアントのモバイルにプッシュ通知するなどの用途に利用できます。  
また、変更内容が24時間残っているため、誤った削除や変更を行ってしまった場合にも、ポイントインタイムリカバリを行わずに特定の項目のみ復旧することが可能です。

### DynamoDBの拡張性
- スループットキャパシティ
RCU（ReadCapacityUnit）とWCU（WriteCapacityUnit）の2つは、スループットキャパシティと呼ばれています。
設定方法は以下の3通りから選ぶ(無停止で変更も可能)

- プロビジョニングされたキャパシティ設定
スループットキャパシティの値として固定値を設定する方法です。  
スループットキャパシティにはソフトリミットがかけられています（リージョンによって上限値が異なります）ので、キャパシティを増やす場合は、AWSサポートに連絡する必要があります。

- RCU
RCUは、読み込みのスループットキャパシティです。1RCUあたり、4KBまでの項目を1秒間に2回読み込むことができます。強力な整合性の読み込みを行った場合は、キャパシティを2倍消費するため、4KBまでの項目を1秒間に1回読み込むことができます。

- WCU
WCUは、書き込みのスループットキャパシティです。1WCUあたり、1KBまでの項目を1秒間に1回書き込むことができます。  
1KBを超える項目を書き込む場合は、1KB単位で切り上げて計算します。たとえば1.5KBの項目を書き込む場合は、2WCUを消費することになります。

- スループットキャパシティのAutoScaling

RCUとWCUには、それぞれAutoScalingを設定することができます。  
AutoScalingでは最小キャパシティユニット、最大キャパシティユニット、ターゲット使用率の3つの値を設定します。  
AutoScalingでは、リクエストの数によってスループットキャパシティを最小キャパシティユニット以上、かつ最大キャパシティユニット以下の範囲で自動的に拡張・縮退します。


- DynamoDB Accelerator
DynamoDBのインメモリキャッシュサービスです。DynamoDBの読み込み速度は一般的なRDBMSと比較して非常に高速ですが、より高速な読み込みが必要な場合は、DAXを利用します

強力な整合性の読み込みクエリが実行された場合、DAXは何もせずDynamoDBにクエリを発行し、レスポンスをそのままクライアントに返します。このとき、結果はキャッシュされません。

## DynamoDBのセキュリティ

- アクセス制御
、テーブルへのアクセス制御にIAMポリシーを利用します。DynamoDBテーブルにアクセスする際は、アクセスを許可したIAMポリシーをアタッチしたIAMロールやIAMユーザーを用います。

- 暗号化
KMSを利用して保存データを暗号化できます。暗号化の設定は、DynamoDBのテーブルの作成時のみ可能です。  
使用するKMSのキーはすべてのテーブルで共通であり、テーブルごとに異なるキーを使用することはできません。  
また、DynamoDBへのアクセスはIAMポリシーを利用して制御するため、暗号化されたテーブルにアクセスする場合は、KMSへのアクセス許可があるIAMポリシーが必要です。

## その他
- グローバルセカンダリインデックス(GSI)
https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/GSI.html




